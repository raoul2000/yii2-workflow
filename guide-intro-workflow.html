<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="language" content="en" />
        <link href="./assets/ca9878b0/css/bootstrap.css" rel="stylesheet">
<link href="./assets/e4a78afa/style.css" rel="stylesheet">
<script src="./assets/dac0333d/jquery.js"></script>
<script src="./assets/ca9878b0/js/bootstrap.js"></script>
<script src="./assets/23719cdf/jssearch.js"></script>    <title>About Workflows - Introduction - Yii2-Workflow Guide</title>
</head>
<body>

<div class="wrap">
    <nav id="w40" class="navbar-inverse navbar-fixed-top navbar" role="navigation"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#w40-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="./index.html">Yii2-Workflow Guide</a></div><div id="w40-collapse" class="collapse navbar-collapse"><ul id="w41" class="navbar-nav nav"><li><a href="./index.html">Class reference</a></li>
<li><a href="./guide-README.html">Guide</a></li></ul><div class="navbar-form navbar-left" role="search">
  <div class="form-group">
    <input id="searchbox" type="text" class="form-control" placeholder="Search">
  </div>
</div>
</div></nav>
    <div id="search-resultbox" style="display: none;" class="modal-content">
        <ul id="search-results">
        </ul>
    </div>

    
<div class="row">
    <div class="col-md-2">
                <div id="navigation" class="list-group"><a class="list-group-item active" href="#navigation-36" data-toggle="collapse" data-parent="#navigation">Introduction <b class="caret"></b></a><div id="navigation-36" class="submenu panel-collapse collapse in"><a class="list-group-item active" href="./guide-intro-workflow.html">About Workflows</a>
<a class="list-group-item" href="./guide-intro-installation.html">Installing yii2-workflow</a>
<a class="list-group-item" href="./guide-intro-upgrade-from-v1.html">Upgrading from Version 1.x</a></div>
<a class="list-group-item" href="#navigation-37" data-toggle="collapse" data-parent="#navigation">Key Concepts <b class="caret"></b></a><div id="navigation-37" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-concept-overview.html">Overview</a>
<a class="list-group-item" href="./guide-concept-source.html">Workflow Source</a>
<a class="list-group-item" href="./guide-concept-events.html">Workflow Events</a>
<a class="list-group-item" href="./guide-concept-validation.html">Workflow Driven Attribute Validation</a></div>
<a class="list-group-item" href="#navigation-38" data-toggle="collapse" data-parent="#navigation">Workflow Components <b class="caret"></b></a><div id="navigation-38" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-workflow-behavior.html">Behavior</a>
<a class="list-group-item" href="./guide-source-file.html">File Source</a></div>
<a class="list-group-item" href="#navigation-39" data-toggle="collapse" data-parent="#navigation">Special topics <b class="caret"></b></a><div id="navigation-39" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-special-cookbook.html">Cookbook</a></div></div>    </div>
    <div class="col-md-9 guide-content" role="main">
        <h1>About Workflows <a href="#about-workflows" id="about-workflows" class="hashlink">&para;</a></h1><p>According to wikipedia :</p>
<blockquote><p>A workflow consists of a sequence of connected steps. It is a depiction of a sequence of operations, declared 
as work of a person, a group of persons, an organization of staff, or one or more simple or complex mechanisms. 
Workflow may be seen as any abstraction of real work, segregated in workshare, work split or other types of ordering. 
For control purposes, workflow may be a view on real work under a chosen aspect, thus serving as a virtual 
representation of actual work. 
(<em><a href="http://en.wikipedia.org/wiki/Workflow">read more on Wikipedia</a></em>)</p>
</blockquote>
<p>Workflows (also called Petri net) is a vast subject and the aim of this document is not to go deeply in the theorical fields. 
As described in the next chapter, the <strong>SimpleWorkflow</strong> behavior only implements a simple subset of it.  if you are interested in 
better understanding theorical basis on the subject, you'll find some <a href="#references">references</a> at the end of this page. </p>
<h2>Use case : a blog <a href="#use-case-a-blog" id="use-case-a-blog" class="hashlink">&para;</a></h2><p>To demonstrate how the workflow concept can be used in a valuable way, let's consider a real life example : a Blog. 
In a typical blog, you would find a model for Post with a <em>status</em> attribute that accept 3 values defined
as class constants (this is how status were implemented on the "old" <a href="https://github.com/yiisoft/yii/blob/master/demos/blog/protected/models/Post.php#L15">yii 1.x demo blog</a>). </p>
<p><code>models/Post.php</code>	</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;</span><span style="color: #0000BB">STATUS_DRAFT</span><span style="color: #007700">=</span><span style="color: #0000BB">1</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;</span><span style="color: #0000BB">STATUS_PUBLISHED</span><span style="color: #007700">=</span><span style="color: #0000BB">2</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;</span><span style="color: #0000BB">STATUS_ARCHIVED</span><span style="color: #007700">=</span><span style="color: #0000BB">3</span><span style="color: #007700">;</span></code></pre>
<p>It is quite obvious that theses values define possible states of a Post instance. Moreover, a set of rules are used to 
define how posts will evolve among these 3 statuses : when you first create a post, it is defined as being <em>draft</em>, 
then it can be <em>published</em> or <em>archived</em>. A <em>published</em> post can become <em>draft</em> (it is then unpublished) or be <em>archived</em>. 
At last an <em>archived</em> post can be <em>published</em> or become <em>draft</em>.</p>
<p>What we have just described here are possible transitions between different statuses of the Post, and if we try to give 
a graphical representation to this description, we'll end up with our first (and very simple) workflow. </p>
<p><img src="images/post-workflow.png" alt="A workflow for the Post model" /></p>
<p>Our workflow definition is:</p>
<ul>
<li>3 statuses : <em>draft</em>, <em>published</em>, <em>archived</em></li>
<li>6 possible transitions</li>
<li>initial status : draft</li>
</ul>
<p>To handle this very simple workflow, there is not much to do as the user has complete freedom to set a post status : any 
status can be reached from any other status and in this case, <em>there is no need</em> for a dedicated extension that would 
handle workflow logic...because there is no workflow logic !</p>
<h2>Use case²: a multi-user publishing system <a href="#use-case-a-multi-user-publishing-system" id="use-case-a-multi-user-publishing-system" class="hashlink">&para;</a></h2><p>Let's imagine something a little bit more complex.</p>
<blockquote><p>Our basic blog is now becoming a multi-user publishing system, where each user is assigned tasks : some are redactors (reporter), 
some make corrections and layout work (they know CSS), and there is of course a chief editors who is responsible for publication.</p>
</blockquote>
<p>If we want to be able to handle posts in our new publishing system, we must think of a more elaborated workflow that will fit this 
new organization. First of all, let's list possible post statuses : </p>
<ul>
<li><strong>draft</strong> : a post is always created as draft. This is the <em>initial status</em> of all posts</li>
<li><strong>correction</strong> : the post is being corrected and layout improvements may also be added</li>
<li><strong>ready</strong> : the post is ready to be published but not yet online</li>
<li><strong>published</strong> : the post is online, available to readers</li>
<li><strong>archived</strong> : the post is not directly available to readers, but can be accessed through the archive section of the site</li>
</ul>
<p>That is not enough, we must also define possible transitions between these statuses. These transitions strongly <strong>depend on how 
the work is going to be organized</strong>, how users of our publishing system will interact with each other. For this example we 
will abritrarly state the following rules : </p>
<ol>
<li>A Post must always be corrected before publication</li>
<li>the chief editor is responsible for publishing/unpublishing posts</li>
<li>the chief editor is responsible for sending a post to archive</li>
</ol>
<p>That will be enough for this example but of course we could (and probably should) add more business rules.
Now, based on what we have just define, here is a possible workflow four our posts : </p>
<p><img src="images/post-workflow-2.png" alt="workflow 2"/></p>
<p>The first version of the "Post worfklow" was very simple, and as each status could reach any other status, there was no need for 
the developer to make any tests when a Post changed status. With this new version, that's another story ! Some logic must 
be implemented in order to prevent <em>Archived</em> post to become <em>Draft</em>, or <em>Published</em> posts to be sent to <em>Correction</em> by a redactor. </p>
<p>That is when <em>SimpleWorkflow</em> can be useful!</p>
<h3>Workflow Definition <a href="#workflow-definition" id="workflow-definition" class="hashlink">&para;</a></h3><p>So we have a nice workflow, let's see how the <em>SimpleWorkflowBehavior</em> can help in managing our Post models life-cycle inside this workflow.
First we must create a definition for our workflow. </p>
<p>The default workflow definition format supported by <em>yii2-workflow</em> is a PHP array. Basically, you provide a class that contains the method <code>getDefinition()</code>, and
this method returns the workflow definition as a PHP array.</p>
<p>The class is named <strong>PostWorkflow</strong> which is by convention the name of a workflow associated with the <em>Post</em> model. It is located in
<code>@app/models</code>, the default location where workflow definitions are stored. Note that these conventions and default settings 
can of course be overloaded with values provided by the developer at initialisation (this will be discussed later).</p>
<p>Let's see how our workflow definition looks like : </p>
<p><code>@app/models/PostWorkflow.php</code></p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">app</span><span style="color: #007700">\</span><span style="color: #0000BB">models</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">PostWorkflow&nbsp;</span><span style="color: #007700">implements&nbsp;\</span><span style="color: #0000BB">raoul2000</span><span style="color: #007700">\</span><span style="color: #0000BB">workflow</span><span style="color: #007700">\</span><span style="color: #0000BB">source</span><span style="color: #007700">\</span><span style="color: #0000BB">file</span><span style="color: #007700">\</span><span style="color: #0000BB">IWorkflowDefinitionProvider&nbsp;<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getDefinition</span><span style="color: #007700">()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'initialStatusId'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'draft'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'draft'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'transition'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[</span><span style="color: #DD0000">'correction'</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'correction'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'transition'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[</span><span style="color: #DD0000">'draft'</span><span style="color: #007700">,</span><span style="color: #DD0000">'ready'</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'ready'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'transition'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[</span><span style="color: #DD0000">'draft'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'correction'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'published'</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'published'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'transition'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[</span><span style="color: #DD0000">'ready'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'archived'</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'archived'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'transition'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[</span><span style="color: #DD0000">'ready'</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>It's quite straightforward to understand isn't it ?  </p>
<p>Note that a more condensed array format is also supported, but for this example we will use this one as it allows more customization.</p>
<h2>Attaching the behavior <a href="#attaching-the-behavior" id="attaching-the-behavior" class="hashlink">&para;</a></h2><p>To be able to manage our Post model inside the workflow, we must take care about following points :</p>
<ul>
<li><em>check that the Post inherits from</em> <code>yii\base\Model</code> : the <em>SimpleWorkflowBehavior</em> can only be attached to Model objects and in fact
most of the time it will be attached to <code>\yii\db\ActiveRecord</code> Objects.</li>
<li>ensure that the Post class include an attribute (or a property) that will be used to store the current status of a post. 
We will use attribute <code>status</code> with type VARCHAR(40) for our example, but it can be any attribute.</li>
</ul>
<p>Attaching the behavior to our model is a standard Yii2 operation. For more information on Yii2 Behaviors please 
refer the <a href="http://www.yiiframework.com/doc-2.0/guide-concept-behaviors.html">The Definitive Guide to Yii2.0</a>.</p>
<p><code>Post.php in @app/models</code></p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">app</span><span style="color: #007700">\</span><span style="color: #0000BB">models</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">/**<br />&nbsp;*&nbsp;@property&nbsp;integer&nbsp;$id<br />&nbsp;*&nbsp;@property&nbsp;string&nbsp;$title<br />&nbsp;*&nbsp;@property&nbsp;string&nbsp;$body<br />&nbsp;*&nbsp;@property&nbsp;string&nbsp;$status&nbsp;column&nbsp;used&nbsp;to&nbsp;store&nbsp;the&nbsp;status&nbsp;of&nbsp;the&nbsp;post<br />&nbsp;*/<br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">behaviors</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\</span><span style="color: #0000BB">raoul2000</span><span style="color: #007700">\</span><span style="color: #0000BB">workflow</span><span style="color: #007700">\</span><span style="color: #0000BB">base</span><span style="color: #007700">\</span><span style="color: #0000BB">SimpleWorkflowBehavior</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...</span></code></pre>
<p>We now have a <em>Post</em> model with workflow capabilities. Let's see how we can use it.</p>
<h2>Basic Status Usage <a href="#basic-status-usage" id="basic-status-usage" class="hashlink">&para;</a></h2><h3>Assignement and Initial Status <a href="#assignement-and-initial-status" id="assignement-and-initial-status" class="hashlink">&para;</a></h3><p>The first operation you'll probably need to perform is assigning a status to your model. The natural way to do this is by simply
assigning a value to the <code>status</code> attribute.</p>
<pre><code class="language-php"><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'published'</span><span style="color: #007700">;</span></code></pre>
<p>When you assign a value to the <code>status</code> attribute, no verification is done against the workflow and the <em>SimpleWorkflowBehavior</em> is
not event invoked in any way. <strong>The status validation occurs when the status attribute is saved</strong> : at this time only, the
post object is considered as really sent to a specific status.</p>
<p>The status validation consists in verifying that the model can perform the transition between its actual status and the value assigned
to the <code>status</code> attribute.</p>
<p>Let's consider the following code : </p>
<pre><code class="language-php"><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'published'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();</span></code></pre>
<p>When we run this code, we get an Exception !</p>
<pre><code>Workflow Exception – raoul2000\workflow\base\WorkflowException
Not an initial status : PostWorkflow/published ("PostWorkflow/draft" expected)	

</code></pre>
<p>Could it be more clear ? Ok, maybe it could but let's see in detail what just happened. </p>
<p>The <em>SimpleWorkflowBehavior</em> enters in action when the Post is saved. At this point it tests if the transitions is possible
between the current status (managed internally by the behavior) and the final one (assigned to the <code>status</code> attribute). 
In our case, there was no current status (the object has just been created) and the final
status has been set to <em>published</em>, so, from the <em>SimpleWorkflowBehavior</em> point of view, we are dealing with the following transition : </p>
<pre><code>null -&gt; 'published'

</code></pre>
<p>This transition is particular as it happens <strong>only when a model enters into a workflow</strong>. If you remember well, the <em>PostWorkflow</em> definition 
above contained a key called <code>initialStatusId</code>. This key is used to define the status Id that must be used by any model when entering a workflow. This is a built-in 
constraint : the first status assigned to a model must be the one defined in the <code>initialStatusId</code> key.</p>
<p>Obviously we didn't comply with this rule as we tried to enter into the workflow through the <em>published</em> status and that's why we received an
exception advising us to use <em>PostWorkflow/draft</em> instead.</p>
<p>Let's follow this wise advice :</p>
<pre><code class="language-php"><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'draft'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();<br />echo&nbsp;</span><span style="color: #DD0000">'the&nbsp;status&nbsp;is&nbsp;:&nbsp;'&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status</span><span style="color: #007700">;</span></code></pre>
<p>Now our post is saved correctly and the output is. </p>
<pre><code>the status is : PostWorkflow/draft 
</code></pre>
<p>Hey wait ! what's that ? we set the <code>status</code> attribute to <em>draft</em>, saved the post and now the value of our <code>status</code> attribute is <em>PostWorkflow/draft</em>. All
right, don't panic, this is just the way the <em>SimpleWorkflowBehavior</em> has normalized the status id, from its short form (<em>draft</em>)
to its absolute form (<em>PostWorkflow/draft</em>). We will describe this later in a chapter dedicated to the <em>WorkflowSource</em> component.
For the moment just remember that these 2 forms of writing a status are equivalent.</p>
<h3>sendToStatus <a href="#sendtostatus" id="sendtostatus" class="hashlink">&para;</a></h3><p>Another way of assigning a status to our Post model is by using the method <code>sendToStatus()</code> defined in the <em>SimpleWorkflowBehavrior</em> behavior. 
When you use <code>sendToStatus()</code> it is not required to save the model for the <em>SimpleWorkflowBehavrior</em> to enter in action. A call to
<code>sendToStatus()</code> will perform following tasks :</p>
<ul>
<li>retrieve the current status (stored internally by the <em>SimpleWorkflowBehavior</em>)</li>
<li>find a transition between the current status and the one passed as argument</li>
<li>if such a transition exists, ensure that it can be used and that it is valid</li>
<li>on success, apply the transition and update the <code>status</code> attribute owned by the Post model.</li>
</ul>
<p>Note that <strong><em>sendToStatus()</em> actually performs the transition : the model leaves it current status and goes to the new one.</strong> It is equivalent
to <code>status</code> attribute assignment and model being saved.</p>
<p>In the example below, the output is the same as before, without having to invoke <em>save()</em>.</p>
<pre><code class="language-php"><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendToStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'draft'</span><span style="color: #007700">);<br />echo&nbsp;</span><span style="color: #DD0000">'the&nbsp;status&nbsp;is&nbsp;:&nbsp;'&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status</span><span style="color: #007700">;</span></code></pre>
<p>And of course if we try to break the <em>initial status</em> rule again, we will also get the same exception as before.</p>
<pre><code class="language-php"><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendToStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'published'</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;exception&nbsp;is&nbsp;thrown&nbsp;here&nbsp;!</span></code></pre>
<p>It is important to remember that by definition, a call to <code>sendToStatus()</code> does not handle persistence of the model, and it is your responsability
to ensure that the model is saved correctly, when needed.</p>
<h3>Summary <a href="#summary" id="summary" class="hashlink">&para;</a></h3><p>The <em>SimpleWorkflowBehavior</em> maintains internally the <em>real</em> value of the current model status.
To actually change the status of a model you have two options :</p>
<ul>
<li>assign a value to the <code>status</code> attribute and save (or update) it : the value assigned to the <code>status</code> attribute
is considered as the end status of the pending transition that will be committed when the <code>status</code> attribute is saved</li>
<li>call  <code>sendToStatus('endStatus')</code> with the end status as argument : the transition between the <em>real</em> status and the one passed as argument
is committed immediately.</li>
</ul>
<h2>Getting the Status <a href="#getting-the-status" id="getting-the-status" class="hashlink">&para;</a></h2><p>If status assignment can be done by assigning a value to the <code>status</code> attribute, getting the status value of a model should not involve
accessing this attribute directly but use the method <code>getWorkflowStatus()</code> instead. However in certain circumstances, reading the status 
attribute value is acceptable, but then it is your responsibility to ensure that both values are synchronized.</p>
<h3>getWorkflowStatus() vs attribute <a href="#getworkflowstatus-vs-attribute" id="getworkflowstatus-vs-attribute" class="hashlink">&para;</a></h3><p>When you call <code>getWorkflowStatus()</code> on a model attached to the <em>SimpleWorkflowBehavior</em>, you will get the instance of the 
status your model is currently in. The type of the object returned in this case is <em>\raoul2000\workflow\base\Status</em>. If your model is
not in a workflow, <code>getWorkflowStatus()</code> returns NULL.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;first&nbsp;save&nbsp;a&nbsp;post&nbsp;in&nbsp;status&nbsp;'draft'&nbsp;<br /></span><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendToStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'draft'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;now&nbsp;read&nbsp;this&nbsp;post&nbsp;and&nbsp;output&nbsp;its&nbsp;status&nbsp;label<br /></span><span style="color: #0000BB">$post2&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">id</span><span style="color: #007700">);<br />echo&nbsp;</span><span style="color: #DD0000">'(1)&nbsp;the&nbsp;status&nbsp;is&nbsp;:&nbsp;'&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$post2</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getWorkflowStatus</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">getId</span><span style="color: #007700">();<br />echo&nbsp;</span><span style="color: #DD0000">'(2)&nbsp;the&nbsp;status&nbsp;is&nbsp;:&nbsp;'&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$post2</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status</span><span style="color: #007700">;</span></code></pre>
<p>The output is :</p>
<pre><code>(1) the status is : PostWorkflow/draft 
(2) the status is : PostWorkflow/draft 
</code></pre>
<p>Seeing at this result, it is not obvious why we should use the <code>getWorkflowStatus()</code> method instead of direct attribute access to get
the status of a model. Ok but remember that the <code>status</code> attribute may not contain the actual value of the model's status, until this model is 
saved (or updated). </p>
<p>Let's see that on an example. In the code below, 2 functions are modifying and returning a newly created Post object. The problem
is they are both accessing the <code>status</code> attribute assuming it contains the actual status value of the post. </p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">foo</span><span style="color: #007700">(</span><span style="color: #0000BB">$post</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;do&nbsp;some&nbsp;fancy&nbsp;stuff&nbsp;here&nbsp;...<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if(&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'draft'</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">;<br />}<br /><br />function&nbsp;</span><span style="color: #0000BB">bar</span><span style="color: #007700">(</span><span style="color: #0000BB">$post</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;do&nbsp;even&nbsp;more&nbsp;some&nbsp;fancy&nbsp;stuff&nbsp;here&nbsp;...<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if(&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #DD0000">'draft'</span><span style="color: #007700">){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'correction'</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">foo</span><span style="color: #007700">(new&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">());<br /></span><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">bar</span><span style="color: #007700">(</span><span style="color: #0000BB">$post</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;keep&nbsp;the&nbsp;faith</span></code></pre>
<p>Can you guess what happens when the model is saved ?  Well, that's when the <em>SimpleWorkflowBehavior</em> enter into action, but that's too late... 
The value of the <code>status</code> attribute is <em>correction</em> and the <em>real</em> status value stored internally by the behavior is NULL. From the 
<em>SimpleWorkflowBehavior</em> point of view, this post object is trying to enter into a workflow through the <em>correction</em> status 
and we already know this is not permitted : bang ! Same exception again ! </p>
<pre><code>Workflow Exception – raoul2000\workflow\base\WorkflowException
Not an initial status : PostWorkflow/published ("PostWorkflow/draft" expected) 
</code></pre>
<p>This small example tries to illustrate the danger of using the status attribute to know the actual status of the object. Very much care should 
be taken when doing this and remember that <strong>the value of the status attribute does not always reflect the actual Status of a model</strong>.</p>
<p>Below is a safe version of the previous example. All access are done through the <em>SimpleWorkflowBehavior</em> behavior. </p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">foo</span><span style="color: #007700">(</span><span style="color: #0000BB">$post</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;test&nbsp;if&nbsp;$post&nbsp;is&nbsp;currently&nbsp;in&nbsp;a&nbsp;workflow<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if(&nbsp;!&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasWorkflowStatus</span><span style="color: #007700">()&nbsp;)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendToStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'draft'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">;<br />}<br /><br />function&nbsp;</span><span style="color: #0000BB">bar</span><span style="color: #007700">(</span><span style="color: #0000BB">$post</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;note&nbsp;that&nbsp;we&nbsp;use&nbsp;the&nbsp;absolute&nbsp;form&nbsp;of&nbsp;the&nbsp;status&nbsp;Id<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if(&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getWorkflowStatus</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">getId</span><span style="color: #007700">()&nbsp;==&nbsp;</span><span style="color: #DD0000">'PostWorkflow/draft'</span><span style="color: #007700">){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendToStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'correction'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">foo</span><span style="color: #007700">(new&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">());<br /></span><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">bar</span><span style="color: #007700">(</span><span style="color: #0000BB">$post</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();</span></code></pre>
<p>That being said, if you know what you are doing you can of course use the <code>status</code> attribute directly to perform some operations. In this
case remember that when the <code>status</code> value is set by the <em>SimpleWorkflowBehavior</em> the absolute form of status id is used (e.g workflowId/statusId).</p>
<h2>Workflow Tasks <a href="#workflow-tasks" id="workflow-tasks" class="hashlink">&para;</a></h2><p>Being able to garantee that the model status will only use authorized transition is nice, but the <em>SimpleWorkflowBehavior</em><br />
provides a way to add some logic to worfklows.</p>
<p>Let's imagine that we want to improve our Publishing System with this new business rule : </p>
<p>&gt;We have noticed that people in charge of correction are not so reactive, which increases the publication delay. 
They say it's because they never know when a new post is ready to be corrected and so, we decide to improve our Blog by sending an email 
to all correctors, as soon as a new post is requesting correction.</p>
<p>This can be achieved very easely by adding a <strong>task</strong> to our workflow, on the transition that goes from the <em>draft</em> status
to the <em>correction</em> status. In the (incomplete) workflow representation below, this task is symbolized by a little green 
square attached to the transition.</p>
<p><img src="images/sw-3.png"/> </p>
<p>Let's see how to implement this <em>sendMail()</em> task and include it in our workflow :</p>
<p><code>@app/models/Post.php</code></p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">use&nbsp;</span><span style="color: #0000BB">raoul2000</span><span style="color: #007700">\</span><span style="color: #0000BB">workflow</span><span style="color: #007700">\</span><span style="color: #0000BB">events</span><span style="color: #007700">\</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">init</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">on</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">afterChangeStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'PostWorkflow/draft'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'PostWorkflow/correction'</span><span style="color: #007700">),&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'sendMail'</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">sendMail</span><span style="color: #007700">(</span><span style="color: #0000BB">$event</span><span style="color: #007700">)&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">MailingService</span><span style="color: #007700">::</span><span style="color: #0000BB">sendMailToCorrector</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'A&nbsp;Post&nbsp;is&nbsp;ready&nbsp;for&nbsp;correction'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'The&nbsp;post&nbsp;['&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sender</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">owner</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">title&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">']&nbsp;is&nbsp;ready&nbsp;to&nbsp;be&nbsp;corrected.'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></pre>
<p>If you know a little bit about <em>Events</em> in Yii2, you may have recognized what happens on the <code>init()</code> method of our Post model : we 
have attached an event handler to the event returned by the call to <code>WorkflowEvent::afterChangeStatus('PostWorkflow/draft', 'PostWorkflow/correction')</code>
which is nothing more than a helper method that creates the actual event name for us.</p>
<p>If you're not familiar with the concept of Event in Yii2, you have a look to 
the <a href="http://www.yiiframework.com/doc-2.0/guide-concept-events.html">Yii2 definitive Guide</a>.</p>
<h3>The Event Model <a href="#the-event-model" id="the-event-model" class="hashlink">&para;</a></h3><p>The <em>SimpleWorkflowBehavior</em> is built around Yii2 events. Most of the time when something intresting happens in a workflow, an event is fired, and that's
your job to decide what to do : catch it and use it or let it go, let it free, <a href="https://youtu.be/ajCYQL8ouqw">let it be</a>.</p>
<p>There are workflow events for almost everything :</p>
<ul>
<li>when a model enters in a workflow</li>
<li>when a model leaves a workflow</li>
<li>when a model enters in a status</li>
<li>when a model leaves a status</li>
</ul>
<p>For even more control, each event from the above list is splitted its <em>before</em> and <em>after</em> variation. When working with events, it is important to
understand when each one is fired so to choose the appropriate one to perform a task. In the previous example we have
declared an <em>event handler</em> in charge of sending a mail to the corrector people, when the post changes from status <em>draft</em> to <em>correction</em>. That's already
something, but it doesn't completely satisfies our requirement which was :</p>
<blockquote><p>[...] sending an email to all correctors, as soon as a new post is requesting correction.</p>
</blockquote>
<p>If we take a look to our workflow, we can see that there are 2 ways to reach the status <em>correction</em> : one coming from <em>draft</em> the 
other coming from <em>ready</em>... and this last one is not taken into account by the current event handler installed the the Post model.</p>
<p>We could of course handle both transitions, but what if tomorrow, a new transition to <em>correction</em> is added ? To be sure to still notify correctors, the
proper solution would be to handle the <em>enter to status</em> event. </p>
<p>The event handler registration now becomes : </p>
<pre><code class="language-php"><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">on</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">afterEnterStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'PostWorkflow/correction'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'sendMail'</span><span style="color: #007700">]<br />);</span></code></pre>
<p>The <em>AfterEnterStatus</em> event is fired each time a models enters into a status, no matter what is its start status. The <em>sendMail()</em> method 
will be invoked each time a post model enters into the status <em>correction</em>, <strong>no matters where it comes from</strong>. </p>
<p>Ok, next requirement ! .. yes, we have some business rules to implement in our super great multi-user publishing system ! (I hope you didn't 
forgot it). One of our rule was :</p>
<blockquote><p>the chief editor is responsible for publishing/unpublishing posts</p>
</blockquote>
<p>In our workflow, the only way for a post to reach the <em>published</em> status is coming from status <em>ready</em>. The rule above can be turned into 
something more "workflow oriented" like "<em>a post can be sent to status 'published' only by a chief editor</em>". Using the appropriate workflow event and
<a href="http://www.yiiframework.com/doc-2.0/guide-security-authorization.html">Yii2 RBAC</a> feature we can easely implement this rule in the Post model.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">use&nbsp;</span><span style="color: #0000BB">raoul2000</span><span style="color: #007700">\</span><span style="color: #0000BB">workflow</span><span style="color: #007700">\</span><span style="color: #0000BB">events</span><span style="color: #007700">\</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">init</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">on</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">beforeEnterStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'PostWorkflow/published'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;(</span><span style="color: #0000BB">$event</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">isValid&nbsp;</span><span style="color: #007700">=&nbsp;\</span><span style="color: #0000BB">Yii</span><span style="color: #007700">::</span><span style="color: #0000BB">$app</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">user</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">can</span><span style="color: #007700">(</span><span style="color: #DD0000">'chief.editor'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;.....</span></code></pre>
<p>Assuming we have created the <em>chief.editor</em> permission, this event handler only checks if it has been assigned to the current user. If that's
not the case, the <code>$event</code> object <strong>is set as invalid</strong> and when this happens in a <em>before</em> event, it interrupts immediately the process of transition
validation : <strong>the model will not be able to reach the end status</strong> ( here <em>published</em>).</p>
<p>Yes, you understood well (I hope) : invalidating a <em>before</em> event will block the transition. Events like <em>beforeEnterStatus</em>, <em>beforeEnterWorkflow</em>,
<em>beforeLeaveStatus</em> etc .. are concerned but if you do the same thing on <em>afterChangeStatus</em> for example, nothing will happen, that's too late .. sorry.</p>
<p>There's more than that and events in <em>SimpleWorkflow</em> is a vas subject that is covered in detailed in <a href="guide-concept-events.html">another chapter</a>. </p>
<h2>Workflow Driven Model Validation <a href="#workflow-driven-model-validation" id="workflow-driven-model-validation" class="hashlink">&para;</a></h2><p>When dealing with complex workflows where model validation rules are strongly related to statuses and user interaction is required, 
attributes validation can quickly become a nightmare to handle</p>
<p>Again, let's see that on an example.</p>
<blockquote><p>In our publishing System, a Post has various attributes : <em>category</em>, <em>tags</em>, <em>priority</em>, etc... These attributes are not set at the Post creation 
but at different moment of its life-cycle in the workflow. For instance, we decide that the author must give a category to the Post, 
the correction team is in charge of adding tags, and at last the chief editor is responsible for setting a priority to the Post. </p>
</blockquote>
<p>In terms of validation rules for the Post model, this new requirement can be defined by 3 statements :</p>
<ul>
<li>When the Post is sent from <em>draft</em> to <em>correction</em> status, it must have a <strong>category</strong></li>
<li>When the Post enter into status <em>ready</em>, it must have <strong>tags</strong></li>
<li>When the Post is sent from <em>ready</em> to <em>published</em> status, is must have a <strong>priority</strong></li>
</ul>
<p>Theses validation could of course be implemented using the event model we saw in the previous chapter : in the appropriate event handler we would test
the appropriate attribut. Ok but why reinventing the wheel when Yii2 provides a 
great <a href="http://www.yiiframework.com/doc-2.0/guide-input-validation.html">Model Validation</a> feature ? Why not use it ? </p>
<p><em>SimpleWorkflow</em> doesn't only provide a behavior, it also came with a custom validator that will help us in verifying that on a specific transition
our model attributes are correct. In the example below, we will check the first rule  : in the <em>draft</em> to <em>correction</em> transition, the attribute
<em>category</em> is required.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">use&nbsp;</span><span style="color: #0000BB">raoul2000</span><span style="color: #007700">\</span><span style="color: #0000BB">workflow</span><span style="color: #007700">\</span><span style="color: #0000BB">validation</span><span style="color: #007700">\</span><span style="color: #0000BB">WorkflowValidator</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">rules</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[[</span><span style="color: #DD0000">'status'</span><span style="color: #007700">],&nbsp;</span><span style="color: #0000BB">WorkflowValidator</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">()],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #DD0000">'name'</span><span style="color: #007700">,</span><span style="color: #DD0000">'required'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'on'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'from&nbsp;{Post3Workflow/draft}&nbsp;to&nbsp;{Post3Workflow/correction}'</span><span style="color: #007700">],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br />&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></pre>
<p>In order to enable workflow driven attribute validation, it is required to use the <code>raoul2000\workflow\validation\WorkflowValidator</code> validator. 
When you validate the <code>status</code> attribute, the <em>WorkflowValidator</em> creates a scenario name based on the transition that is about to occur. Remember
that the pending transition is the one that goes from the <strong>actual</strong> status of the model (maintained internally by the <em>SimpleWorkflowBehavior</em>) and
the <strong>future</strong> status (assigned to the <code>status</code> attribute). Once the scenario name is created, the <em>WorkflowValidator</em> applies all validation rules
that matches the scenario.</p>
<p>In the following example, our post instance is first sent to status <em>draft</em> using the <code>sendToStatus()</code> method, and then to 'correction' using <code>save()</code>
which by default initiates the model validation.</p>
<pre><code class="language-php"><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sendToStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'draft'</span><span style="color: #007700">);&nbsp;</span><span style="color: #FF8000">//&nbsp;=&nbsp;success&nbsp;:&nbsp;the&nbsp;current&nbsp;status&nbsp;is&nbsp;'draft'<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">status&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'correction'</span><span style="color: #007700">;<br />if(&nbsp;!&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">()&nbsp;)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;pending&nbsp;transition&nbsp;is&nbsp;draft&nbsp;-&gt;&nbsp;correction<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getFirstError</span><span style="color: #007700">(</span><span style="color: #DD0000">'name'</span><span style="color: #007700">);<br />}</span></code></pre>
<p>The output : </p>
<pre><code>Name cannot be blank.
</code></pre>
<p>Based on scenario names which are meaningfull in a workflow context, we can define validation rules for any attribute model, just like you would do
with any other scenario.</p>
<h3>Workflow Scenario <a href="#workflow-scenario" id="workflow-scenario" class="hashlink">&para;</a></h3><p>In the previous example we have used the <em>required</em> built-in validator on the <code>name</code> attribute, only for the scenario<br />
<em>from {Post3Workflow/draft} to {Post3Workflow/correction}</em>. This scenario name is created automatically at validation time by the <em>WorkflowValidator</em>
depending on the pending transition. In order to provide maximum flexibility there are several scenario like this one which that are created 
the same way by the <em>WorkflowValidator</em>.</p>
<ul>
<li><em>from {start} to {end}</em> </li>
<li><em>leave status {status}</em> </li>
<li><em>enter status {status}</em></li>
<li><em>enter status {status}</em></li>
<li><em>enter workflow {workflow id}</em></li>
<li><em>leave workflow {workflow id}</em></li>
</ul>
<p>As you can see <em>SimpleWorkflow</em> allows to validate model attributes at different moment of the model life-cycle within a workflow. You could
for instance validate that the attribute <code>tags</code> is not empty when the post model <em>enter status {Post3Workflow/ready}</em>, or 
as soon as the post <em>enter workflow {Post3Workflow}</em>.</p>
<p>The helper class <em>WorkflowScenario</em> is here to assist you with scenario names, and if you favorite IDE includes a nice auto-completion feature
writting scenario name may become a real pleasure (more or less).</p>
<p>Let's rewrite our validation rules using the <em>WorkflowScenario</em> helper:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">use&nbsp;</span><span style="color: #0000BB">raoul2000</span><span style="color: #007700">\</span><span style="color: #0000BB">workflow</span><span style="color: #007700">\</span><span style="color: #0000BB">validation</span><span style="color: #007700">\</span><span style="color: #0000BB">WorkflowValidator</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">rules</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[[</span><span style="color: #DD0000">'status'</span><span style="color: #007700">],&nbsp;</span><span style="color: #0000BB">WorkflowValidator</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">()],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #DD0000">'title'</span><span style="color: #007700">,</span><span style="color: #DD0000">'required'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'on'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">WorkflowScenario</span><span style="color: #007700">::</span><span style="color: #0000BB">changeStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'Post3Workflow/correction'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'Post3Workflow/ready'</span><span style="color: #007700">)&nbsp;],&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #DD0000">'tags'</span><span style="color: #007700">,</span><span style="color: #DD0000">'required'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'on'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">WorkflowScenario</span><span style="color: #007700">::</span><span style="color: #0000BB">enterStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'Post3Workflow/ready'</span><span style="color: #007700">)&nbsp;],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br />&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></pre>
<h2><a name="references"></a>References <a href="#references" id="references" class="hashlink">&para;</a></h2><p>The SimpleWorkflow behavior, is not dedicated to provide a complete workflow driven model that would replace MVC or any other pattern. 
It should only be considered as a set of tools that facilitate workflow managment for simple applications. </p>
<p>If you want to know more about the subject, and discover what a complete workflow engine looks like, here is a list of 
intresting links.</p>
<ul>
<li><a href="http://www.tonymarston.net/php-mysql/workflow.html">An activity based Workflow Engine for PHP</a></li>
<li><a href="http://www.workflowpatterns.com/">Workflow Patterns home page</a></li>
<li><a href="http://workflow.tikiwiki.org/tiki-index.php?page=homepage">Galaxia : an open source workflow engine</a></li>
<li><a href="http://www.ezcomponents.org/docs/api/latest/introduction_Workflow.html">ezComponent : workflow</a></li>
</ul>
        <div class="toplink"><a href="#" class="h1" title="go to top"><span class="glyphicon glyphicon-arrow-up"></a></div>
    </div>
</div>


</div>

<footer class="footer">
        <p class="pull-right"><small>Page generated on Mon, 26 Oct 2015 21:03:20 +0000</small></p>
    Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></footer>

<script type="text/javascript">jQuery(document).ready(function () {
    var shiftWindow = function () { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
var element = document.createElement("script");
element.src = "./jssearch.index.js";
document.body.appendChild(element);

var searchBox = $('#searchbox');

// search when typing in search field
searchBox.on("keyup", function(event) {
    var query = $(this).val();

    if (query == '' || event.which == 27) {
        $('#search-resultbox').hide();
        return;
    } else if (event.which == 13) {
        var selectedLink = $('#search-resultbox a.selected');
        if (selectedLink.length != 0) {
            document.location = selectedLink.attr('href');
            return;
        }
    } else if (event.which == 38 || event.which == 40) {
        $('#search-resultbox').show();

        var selected = $('#search-resultbox a.selected');
        if (selected.length == 0) {
            $('#search-results').find('a').first().addClass('selected');
        } else {
            var next;
            if (event.which == 40) {
                next = selected.parent().next().find('a').first();
            } else {
                next = selected.parent().prev().find('a').first();
            }
            if (next.length != 0) {
                var resultbox = $('#search-results');
                var position = next.position();

//              TODO scrolling is buggy and jumps around
//                resultbox.scrollTop(Math.floor(position.top));
//                console.log(position.top);

                selected.removeClass('selected');
                next.addClass('selected');
            }
        }

        return;
    }
    $('#search-resultbox').show();
    $('#search-results').html('<li><span class="no-results">No results</span></li>');

    var result = jssearch.search(query);

    if (result.length > 0) {
        var i = 0;
        var resHtml = '';

        for (var key in result) {
            if (i++ > 20) {
                break;
            }
            resHtml = resHtml +
            '<li><a href="' + result[key].file.u.substr(3) +'"><span class="title">' + result[key].file.t + '</span>' +
            '<span class="description">' + result[key].file.d + '</span></a></li>';
        }
        $('#search-results').html(resHtml);
    }
});

// hide the search results on ESC
$(document).on("keyup", function(event) { if (event.which == 27) { $('#search-resultbox').hide(); } });
// hide search results on click to document
$(document).bind('click', function (e) { $('#search-resultbox').hide(); });
// except the following:
searchBox.bind('click', function(e) { e.stopPropagation(); });
$('#search-resultbox').bind('click', function(e) { e.stopPropagation(); });

});</script></body>
</html>
