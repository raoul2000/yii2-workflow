<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="language" content="en" />
        <link href="./assets/ca9878b0/css/bootstrap.css" rel="stylesheet">
<link href="./assets/e4a78afa/style.css" rel="stylesheet">
<script src="./assets/dac0333d/jquery.js"></script>
<script src="./assets/ca9878b0/js/bootstrap.js"></script>
<script src="./assets/23719cdf/jssearch.js"></script>    <title>Workflow Events - Key Concepts - Yii2-Workflow Guide</title>
</head>
<body>

<div class="wrap">
    <nav id="w4" class="navbar-inverse navbar-fixed-top navbar" role="navigation"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#w4-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="./index.html">Yii2-Workflow Guide</a></div><div id="w4-collapse" class="collapse navbar-collapse"><ul id="w5" class="navbar-nav nav"><li><a href="./index.html">Class reference</a></li>
<li><a href="./guide-README.html">Guide</a></li></ul><div class="navbar-form navbar-left" role="search">
  <div class="form-group">
    <input id="searchbox" type="text" class="form-control" placeholder="Search">
  </div>
</div>
</div></nav>
    <div id="search-resultbox" style="display: none;" class="modal-content">
        <ul id="search-results">
        </ul>
    </div>

    
<div class="row">
    <div class="col-md-2">
                <div id="navigation" class="list-group"><a class="list-group-item" href="#navigation-0" data-toggle="collapse" data-parent="#navigation">Introduction <b class="caret"></b></a><div id="navigation-0" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-intro-workflow.html">About Workflows</a>
<a class="list-group-item" href="./guide-intro-installation.html">Installing yii2-workflow</a>
<a class="list-group-item" href="./guide-intro-upgrade-from-v1.html">Upgrading from Version 1.x</a></div>
<a class="list-group-item active" href="#navigation-1" data-toggle="collapse" data-parent="#navigation">Key Concepts <b class="caret"></b></a><div id="navigation-1" class="submenu panel-collapse collapse in"><a class="list-group-item" href="./guide-concept-overview.html">Overview</a>
<a class="list-group-item" href="./guide-concept-source.html">Workflow Source</a>
<a class="list-group-item active" href="./guide-concept-events.html">Workflow Events</a>
<a class="list-group-item" href="./guide-concept-validation.html">Workflow Driven Attribute Validation</a></div>
<a class="list-group-item" href="#navigation-2" data-toggle="collapse" data-parent="#navigation">Workflow Components <b class="caret"></b></a><div id="navigation-2" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-workflow-behavior.html">Behavior</a>
<a class="list-group-item" href="./guide-source-file.html">File Source</a></div>
<a class="list-group-item" href="#navigation-3" data-toggle="collapse" data-parent="#navigation">Special topics <b class="caret"></b></a><div id="navigation-3" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-special-cookbook.html">Cookbook</a></div></div>    </div>
    <div class="col-md-9 guide-content" role="main">
        <h1>Workflow Events <a href="#workflow-events" id="workflow-events" class="hashlink">&para;</a></h1><p><em>SimpleWorkflow</em> is making use of <a href="http://www.yiiframework.com/doc-2.0/guide-concept-events.html">Yii2 events</a> to allow customization
of model behavior.  </p>
<p>Basically when something interesting happens to a model inside a workflow, an event is fired, or more precisely a <strong>sequence of events</strong> is
fired.</p>
<h2>Event Sequence <a href="#event-sequence" id="event-sequence" class="hashlink">&para;</a></h2><p>The default event sequence used by the <em>SimpleWorkflow</em> behavior is the <em>BasicEventSequence</em> available in the namespace 
<code>\raoul2000\workflow\events</code>. Below is a list of events fired by this sequence :</p>
<table width="100%">
	<tr>
		<td><b>workflow event</b></td>
		<td><b>Basic Event Sequence</b></td>
	</tr>
	<tr>
		<td>the model enters in workflow W1</td>
		<td>
			<ul>
				<li><b>beforeEnterWorkflow{W1}</b></li>
				<li><b>beforeEnterStatus{W1/init}</b> where 'init' is the initial status Id for the workflow W1</li>
				<li><b>afterEnterWorkflow{W1}</b></li>
				<li><b>afterEnterStatus{W1/init}</b> where 'init' is the initial status Id for the workflow W1</li>
			</ul>
		</td>
	</tr>
	<tr>
		<td>the model goes from status W1/A to W1/B</td>
		<td>
			<ul>
				<li><b>beforeLeaveStatus{W1/A}</b></li>
				<li><b>beforeChangeStatusFrom{W1/A}to{W1/B}</b></li>
				<li><b>beforeEnterStatus{W1/B}</b></li>
				<li><b>afterLeaveStatus{W1/A}</b></li>
				<li><b>afterChangeStatusFrom{W1/A}to{W1/B}</b></li>
				<li><b>afterEnterStatus{W1/B}</b></li>
			</ul>
		</td>
	</tr>	
	<tr>
		<td>the model leaves the workflow W1</td>
		<td>
			<ul>
				<li><b>beforeLeaveStatus{W1/B}</b> where W1/B is the last status Id of the model before it leaves the workflow</li>
				<li><b>beforeLeaveWorkflow{W1}</b></li>
				<li><b>afterLeaveStatus{W1/B}</b> where W1/B is the last status Id of the model before it leaves the workflow</li>
				<li><b>afterLeaveWorkflow{W1}</b></li>
			</ul>
		</td>
	</tr>	
</table> 
<p>Two other event sequences are also available in the same namespace :</p>
<ul>
<li>ReducedEventSequence</li>
<li>ExtendedEventSequence</li>
</ul>
<p>Of course you can create your own event sequence if the ones provided don't meet your needs. To do so, simply create a class that 
implements the <code>raoul2000\workflow\events\IEventSequence</code> interface (see below).</p>
<h2>Configuration <a href="#configuration" id="configuration" class="hashlink">&para;</a></h2><p>When the <em>SimpleWorkflowBehavior</em> is initialized, it tries to get a reference to the <strong>Event Sequence Component</strong> to use. By default
this component is assumed to have the id <em>eventSequence</em>. If no such component is available, <em>it will create one</em> using the <em>BasicEventSequence</em> 
class and register it in the Yii2 application so to make it available to other <em>SimpleWorkflowBehavior</em>.</p>
<p>To summarize :</p>
<ul>
<li><strong>eventSequence</strong> : default Id of the event sequence component used by the <em>SimpleWorkflowBehavior</em></li>
<li><strong>BasicEventSequence</strong> : default event sequence type </li>
</ul>
<p>If for instance you want to use the <em>ReducedEventSequence</em> instead of the default one, you must configure it like you would do for 
any other Yii2 component.</p>
<pre><code class="language-php"><span style="color: #0000BB">$config&nbsp;</span><span style="color: #007700">=&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;....<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'components'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;the&nbsp;default&nbsp;event&nbsp;sequence&nbsp;component&nbsp;is&nbsp;configured&nbsp;as&nbsp;a&nbsp;ReducedEventSequence<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;and&nbsp;not&nbsp;a&nbsp;BasicEventSequence&nbsp;anymore&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'eventSequence'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'class'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'\raoul2000\workflow\events\ReducedEventSequence'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...</span></code></pre>
<p>The <em>SimpleWorkflowBehavior</em> will then use the configured <em>eventSequence</em> component. </p>
<p>You may also want to use a reduced event sequence for one particular workflow, and the basic event sequence with another ones. 
This can be easely achieved by configuring the ID of the event sequence component that a <em>SimpleWorkflowBehavior</em> should use.</p>
<p>In the example below we are first configuring a new component with the ID <em>myReducedEventSequence</em> and with type <em>ReducedEventSequence</em>.</p>
<pre><code class="language-php"><span style="color: #0000BB">$config&nbsp;</span><span style="color: #007700">=&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;....<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'components'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'myReducedEventSequence'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'class'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'\raoul2000\workflow\events\ReducedEventSequence'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...</span></code></pre>
<p>Now let's tell to the behavior of the Post model that it must use the <em>myReducedEventSequence</em> event sequence component configured above 
instead of the default one.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">app</span><span style="color: #007700">\</span><span style="color: #0000BB">models</span><span style="color: #007700">;<br />class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">behaviors</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'class'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;\</span><span style="color: #0000BB">raoul2000</span><span style="color: #007700">\</span><span style="color: #0000BB">workflow</span><span style="color: #007700">\</span><span style="color: #0000BB">base</span><span style="color: #007700">\</span><span style="color: #0000BB">SimpleWorkflowBehavior</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'eventSequence'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'myReducedEventSequence'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>Any other model with a <em>SimpleWorkflowBehavior</em> will keep using the default Event sequence (<em>BasicEventSequence</em>) but the Post model
will use a specific one (<em>ReducedEventSequence</em>).</p>
<p><em>SimpleWorkflow</em> events are enabled by default but can be disabled by setting the <em>eventSequence</em> configuration parameter to NULL when
attaching the behavior to the model. In this case as you may expect, no event is fired for this model.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">app</span><span style="color: #007700">\</span><span style="color: #0000BB">models</span><span style="color: #007700">;<br />class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">behaviors</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'class'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;\</span><span style="color: #0000BB">raoul2000</span><span style="color: #007700">\</span><span style="color: #0000BB">workflow</span><span style="color: #007700">\</span><span style="color: #0000BB">base</span><span style="color: #007700">\</span><span style="color: #0000BB">SimpleWorkflowBehavior</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'eventSequence'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">null&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;disable&nbsp;all&nbsp;SimpleWorkflow&nbsp;Events&nbsp;for&nbsp;Post&nbsp;instances<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<h2>Event Object <a href="#event-object" id="event-object" class="hashlink">&para;</a></h2><p>All events fired are instances of the <code>raoul2000\workflow\events\WorkflowEvent</code> class which provides all the method needed to get informations
on the event that just occured.</p>
<ul>
<li><code>getStartStatus()</code> : returns the Status instance that the model is leaving. If the WorkflowEvent is fired because the model <em>enters</em> into a workflow, this method returns <code>null</code>.</li>
<li><code>getEndStatus()</code> : returns the Status instance that the model is reaching. If the WorkflowEvent is fired because the model <em>leaves</em> a workflow, this method returns <code>null</code>.</li>
<li><code>getTransition()</code> : returns the Transition instance that the model is performing. Note that if the WorkflowEvent is fired because the model <em>enters</em> or <em>leaves</em> the
workflow, this method returns <code>null</code>.</li>
</ul>
<p>Remember that a <code>WorkflowEvent</code> object is passed to all attached handlers(see next chapter).</p>
<h2>Event Handler <a href="#event-handler" id="event-handler" class="hashlink">&para;</a></h2><p>A event handler is used to implement a specific process on any of the events in the event sequence. Installing an event handler is
a standard operation described in the <a href="http://www.yiiframework.com/doc-2.0/guide-concept-events.html#attaching-event-handlers">Yii2 Definitive Guide</a>. </p>
<p>In the example below, we are attaching an handler for the event that is fired when a Post instance goes from the status <em>draft</em> to the
status <em>correction</em>. When this happens, we have decided to send a mail.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">use&nbsp;</span><span style="color: #0000BB">raoul2000</span><span style="color: #007700">\</span><span style="color: #0000BB">workflow</span><span style="color: #007700">\</span><span style="color: #0000BB">events</span><span style="color: #007700">\</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">init</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">on</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'afterChangeStatusFrom{PostWorkflow/draft}to{PostWorkflow/correction}'</span><span style="color: #007700">,&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #0000BB">$this</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'sendMail'</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;$event&nbsp;is&nbsp;an&nbsp;instance&nbsp;of&nbsp;raoul2000\workflow\events\WorkflowEvent<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">sendMail</span><span style="color: #007700">(</span><span style="color: #0000BB">$event</span><span style="color: #007700">)&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">MailingService</span><span style="color: #007700">::</span><span style="color: #0000BB">sendMailToCorrector</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'A&nbsp;Post&nbsp;is&nbsp;ready&nbsp;for&nbsp;correction'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'The&nbsp;post&nbsp;['&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sender</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">owner</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">title&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">']&nbsp;is&nbsp;ready&nbsp;to&nbsp;be&nbsp;corrected.'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></pre>
<h2>before vs after <a href="#before-vs-after" id="before-vs-after" class="hashlink">&para;</a></h2><p>Each event fired by the <em>SimpleWorkflowBehavior</em> can be of 2 types : <strong>before</strong> or <strong>after</strong>. The difference between these types is 
that a handler attached to a <em>before</em> event is able to block the transition in progress by <em>invalidating</em> the event. This is not possible
for a handler attached to a "after* event. Using this feature it becomes possible to block a transition based on the result of a complex
processing.</p>
<p>In the following example, an event handler is attached to be invoked <em>before</em> a Post instance enters into the status 'Post/published'. 
This handler checks that the user who is performing the action has the appropriate permission and if not it <em>invalidates</em> the event : the
Post instance will not be able to reach the status 'W1/A', the transition is blocked. </p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">use&nbsp;</span><span style="color: #0000BB">raoul2000</span><span style="color: #007700">\</span><span style="color: #0000BB">workflow</span><span style="color: #007700">\</span><span style="color: #0000BB">events</span><span style="color: #007700">\</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">init</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">on</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'beforeEnterStatus{Post/published}'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;(</span><span style="color: #0000BB">$event</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;if&nbsp;the&nbsp;user&nbsp;doesn't&nbsp;have&nbsp;the&nbsp;current&nbsp;authorization,&nbsp;the&nbsp;transition&nbsp;to&nbsp;'Post/published'&nbsp;is&nbsp;blocked<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if(&nbsp;\</span><span style="color: #0000BB">Yii</span><span style="color: #007700">::</span><span style="color: #0000BB">$app</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">user</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">can</span><span style="color: #007700">(</span><span style="color: #DD0000">'publish.post'</span><span style="color: #007700">)&nbsp;==&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">invalidate</span><span style="color: #007700">(</span><span style="color: #DD0000">"you&nbsp;don't&nbsp;have&nbsp;permission&nbsp;to&nbsp;publish&nbsp;this&nbsp;post"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;.....</span></code></pre>
<p>Event handlers attached to <em>before</em> events allow you to authorize or forbid a transition based on the result of a custom code execution.</p>
<h3>Status Constraint <a href="#status-constraint" id="status-constraint" class="hashlink">&para;</a></h3><p>If you have been using the previous version of <em>SimpleWorkflow</em> (only compatible with Yii 1.x) you may be familiar with <em>Status Constraint</em>. 
A <em>Status Constraint</em> is a piece of PHP code associated with a status and evaluated as a logical 
expression <strong>before a model enters into this status</strong> : if the evaluation succeeds, the model can enter the status 
otherwise the transition is blocked and the model remains in its current status (<a href="http://s172418307.onlinehome.fr/project/sandbox/www/index.php?r=simpleWorkflow/page&amp;view=doc#constraint">read more</a>).</p>
<p><em>Status Constraint</em> are <strong>not declared anymore as PHP code inside the workflow definition</strong> like in version 1.x but as event handlers
attached to the <em>before</em> event type, just like in the previous example where in fact, we have defined a constraint on the status <em>W1/A</em>. </p>
<p>Remember that an event handler attached to a <em>before</em> event type is able to block the transition by invalidating the event object, and that's
exactly what a <em>Status Constraint</em> does !</p>
<h3>Workflow Tasks <a href="#workflow-tasks" id="workflow-tasks" class="hashlink">&para;</a></h3><p>Just like <em>Status Constraint</em> above, <em>Workflow Task</em> is a feature available with the previous version of <em>SimpleWorkflow</em>.
To summarize, a workflow task is a piece of PHP code attached to a transition and executed when the transition 
is performed by the model ( <a href="http://s172418307.onlinehome.fr/project/sandbox/www/index.php?r=simpleWorkflow/page&amp;view=doc#tasks">read more</a>).</p>
<p>Such feature must now be implemented as an event handler attached to an <em>after</em> event and not anymore as PHP code defined in the workflow
definition (like it used to be in version 1.x). In a <a href="#event-handler">previous chapter</a> we have already created a workflow task by 
attaching a handler to the event <em>afterChangeStatusFrom{PostWorkflow/draft}to{PostWorkflow/correction}</em> : a mail is sent when the model
goes from <code>draft</code> to <code>correction</code>. </p>
<h2>Getting The Event Sequence <a href="#getting-the-event-sequence" id="getting-the-event-sequence" class="hashlink">&para;</a></h2><p>Once <em>SimpleWorkflowBehavior</em> is attached to model, it injects several method that you can use directly from a model instance (this is
<a href="http://www.yiiframework.com/doc-2.0/guide-concept-behaviors.html#using-behaviors">standard Yii2 feature</a>). Among these methods, 
<code>getEventSequence()</code> is particularly useful when working with events. This method returns
an array describing all the events that will be fired if the model is sent to the status passed as argument. This array has 2 keys : 
<em>before</em> and <em>after</em>. The value of each key is an array of <code>raoul2000\workflow\events\WorkflowEvent</code> objects representing the event
that will be fired before and after the transition.</p>
<p>Let's see that on the example below where we assume that the <code>$post</code> instance in currently in status <em>ready</em>. This snippet
is displaying the ordered list of event that will be fired when <code>$post</code> is sent to status <em>published</em>.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;$post&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;in&nbsp;status&nbsp;'ready'<br /></span><span style="color: #007700">foreach&nbsp;(</span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getEventSequence</span><span style="color: #007700">(</span><span style="color: #DD0000">'published'</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$type&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$events</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;foreach(</span><span style="color: #0000BB">$events&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'type&nbsp;=&nbsp;'</span><span style="color: #007700">.</span><span style="color: #0000BB">$type</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">'&nbsp;event&nbsp;name&nbsp;=&nbsp;'</span><span style="color: #007700">.</span><span style="color: #0000BB">$event</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name</span><span style="color: #007700">.</span><span style="color: #DD0000">'&lt;br/&gt;'</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>The transition we are working on is from <em>ready</em> to <em>published</em>. The event sequence used is the default one and here is
the output which matches the <em>BasicEventSequence</em> specifications. </p>
<pre><code>type = before event name = beforeLeaveStatus{PostWorkflow/ready}
type = before event name = beforeChangeStatusFrom{PostWorkflow/ready}to{PostWorkflow/published}
type = before event name = beforeEnterStatus{PostWorkflow/published}
type = after event name = afterLeaveStatus{PostWorkflow/ready}
type = after event name = afterChangeStatusFrom{PostWorkflow/ready}to{PostWorkflow/published}
type = after event name = afterEnterStatus{PostWorkflow/published}
</code></pre>
<p>Remember that events will be fired in this exact order until the last event or until the event is invalidated by a handler attached
to the <em>before</em> events.</p>
<h2>Event Name Helper <a href="#event-name-helper" id="event-name-helper" class="hashlink">&para;</a></h2><p>The class <em>\raoul2000\workflow\events\WorkflowEvent</em> includes a set of static method that you can use to easely create workflow event names.
It's even more useful if your favorite IDE supports auto-completion ! The example below is equivalent to the previous one except that
the event name is created at runtime by a call to <code>WorkflowEvent::beforeEnterStatus('W1/A')</code>.</p>
<pre><code class="language-php"><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">on</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;use&nbsp;the&nbsp;event&nbsp;helper&nbsp;to&nbsp;generate&nbsp;the&nbsp;event&nbsp;name&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">beforeEnterStatus</span><span style="color: #007700">(</span><span style="color: #DD0000">'W1/A'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;(</span><span style="color: #0000BB">$event</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br />);</span></code></pre>
<h2>Creating An Event Sequence <a href="#creating-an-event-sequence" id="creating-an-event-sequence" class="hashlink">&para;</a></h2><p>We already know that <em>SimpleWorkflow</em> includes 3 event sequences, from the most simple to the most <em>verbose</em> one (the default is the
<code>BasicEventSequence</code>). However, you may want to create your own event sequence if for instance you want to optimize the amount of events
fired and actually handled by your implementation.</p>
<p>To define your own event sequence you must create a class that implements the <code>\raoul2000\workflow\events\IEventSequence</code> interface. 
There are three methods declared in this interface, each one being invoked at runtime, when a specific event occurs in the workflow :</p>
<ul>
<li><em>createEnterWorkflowSequence</em> : invoked when a model enters into a workflow</li>
<li><em>createLeaveWorkflowSequence</em> : invoked when a model leaves a workflow</li>
<li><em>createChangeStatusSequence</em> : invoked when a model changes status</li>
</ul>
<p>Each method must return an array representing the corresponding sequence of events, grouped in 2 possibles types : <em>before</em> and 
<em>after</em> events. These types are used as keys in the returned array, and values is an array of <code>WorkflowEvent</code> objects representing
the sequence of events.</p>
<p>For example :</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">createEnterWorkflowSequence</span><span style="color: #007700">(</span><span style="color: #0000BB">$initalStatus</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$sender</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'before'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">beforeEnterWorkflow</span><span style="color: #007700">(</span><span style="color: #0000BB">$initalStatus</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getWorkflowId</span><span style="color: #007700">()),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #DD0000">'end'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$initalStatus</span><span style="color: #007700">,</span><span style="color: #DD0000">'sender'</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$sender</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">beforeEnterStatus</span><span style="color: #007700">(</span><span style="color: #0000BB">$initalStatus</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getId</span><span style="color: #007700">()),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #DD0000">'end'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$initalStatus</span><span style="color: #007700">,</span><span style="color: #DD0000">'sender'</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$sender</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'after'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">afterEnterWorkflow</span><span style="color: #007700">(</span><span style="color: #0000BB">$initalStatus</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getWorkflowId</span><span style="color: #007700">()),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #DD0000">'end'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$initalStatus</span><span style="color: #007700">,</span><span style="color: #DD0000">'sender'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$sender</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">(</span><span style="color: #0000BB">WorkflowEvent</span><span style="color: #007700">::</span><span style="color: #0000BB">afterEnterStatus</span><span style="color: #007700">(</span><span style="color: #0000BB">$initalStatus</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getId</span><span style="color: #007700">()),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span style="color: #DD0000">'end'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$initalStatus</span><span style="color: #007700">,</span><span style="color: #DD0000">'sender'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$sender</span><span style="color: #007700">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br />&nbsp;&nbsp;&nbsp;&nbsp;];<br />}</span></code></pre>
<h2>Generic Events <a href="#generic-events" id="generic-events" class="hashlink">&para;</a></h2><p>We have seen in the previous chapters that using an <em>Event Sequence</em> you can easely implement a custom behavior for your model evolving into a workflow, by installing
the appropriate event handlers: an <em>Event Sequence</em> allows you to react to the exact event you need with a thin control. However, if you don't need such precision, you can 
also use so called <em>generic events</em>.</p>
<p>Two <em>Generic Events</em> are always fired by the <em>SimpleWorkflowBehavior</em> as soon as a model changes status, and this, no matter what <em>Event Sequence</em> is configured. In fact
even if you choose to not use <em>Event Sequence</em>, the <em>Generic Events</em> are fired, because they are fired by the <em>SimpleWorkflowBehavior</em> itself, and not by another component (like
the event sequence component).</p>
<p>The names of the 2 <em>Generic Events</em> are :</p>
<ul>
<li>EVENT_BEFORE_CHANGE_STATUS : fired each time <strong>before</strong> a model changes status</li>
<li>EVENT_AFTER_CHANGE_STATUS : fired each time <strong>after</strong> a model changes status</li>
</ul>
<p>The <em>before</em> and <em>after</em> event type follow the same rules as with <em>Event Sequence</em> and in particular you can block a transition by invalidating the <em>before</em> event.</p>
<p>In order to identify exactly what just happened to your model inside the workflow, you must test what are the values of the <em>startStatus</em> and <em>endStatus</em> by calling the
corresponding <code>WorkflowEvent</code> methods.</p>
<ul>
<li><code>getStartStatus() == null &amp;&amp; getEndStatus() != null</code> : the model is <strong>entering</strong> into the workflow</li>
<li><code>getStartStatus() =! null &amp;&amp; getEndStatus() != null</code> : the model is <strong>changing</strong> status</li>
<li><code>getStartStatus() == null &amp;&amp; getEndStatus() == null</code> : the model is <strong>leaving</strong> into the workflow</li>
</ul>
        <div class="toplink"><a href="#" class="h1" title="go to top"><span class="glyphicon glyphicon-arrow-up"></a></div>
    </div>
</div>


</div>

<footer class="footer">
        <p class="pull-right"><small>Page generated on Fri, 16 Oct 2015 20:07:31 +0000</small></p>
    Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></footer>

<script type="text/javascript">jQuery(document).ready(function () {
    var shiftWindow = function () { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
var element = document.createElement("script");
element.src = "./jssearch.index.js";
document.body.appendChild(element);

var searchBox = $('#searchbox');

// search when typing in search field
searchBox.on("keyup", function(event) {
    var query = $(this).val();

    if (query == '' || event.which == 27) {
        $('#search-resultbox').hide();
        return;
    } else if (event.which == 13) {
        var selectedLink = $('#search-resultbox a.selected');
        if (selectedLink.length != 0) {
            document.location = selectedLink.attr('href');
            return;
        }
    } else if (event.which == 38 || event.which == 40) {
        $('#search-resultbox').show();

        var selected = $('#search-resultbox a.selected');
        if (selected.length == 0) {
            $('#search-results').find('a').first().addClass('selected');
        } else {
            var next;
            if (event.which == 40) {
                next = selected.parent().next().find('a').first();
            } else {
                next = selected.parent().prev().find('a').first();
            }
            if (next.length != 0) {
                var resultbox = $('#search-results');
                var position = next.position();

//              TODO scrolling is buggy and jumps around
//                resultbox.scrollTop(Math.floor(position.top));
//                console.log(position.top);

                selected.removeClass('selected');
                next.addClass('selected');
            }
        }

        return;
    }
    $('#search-resultbox').show();
    $('#search-results').html('<li><span class="no-results">No results</span></li>');

    var result = jssearch.search(query);

    if (result.length > 0) {
        var i = 0;
        var resHtml = '';

        for (var key in result) {
            if (i++ > 20) {
                break;
            }
            resHtml = resHtml +
            '<li><a href="' + result[key].file.u.substr(3) +'"><span class="title">' + result[key].file.t + '</span>' +
            '<span class="description">' + result[key].file.d + '</span></a></li>';
        }
        $('#search-results').html(resHtml);
    }
});

// hide the search results on ESC
$(document).on("keyup", function(event) { if (event.which == 27) { $('#search-resultbox').hide(); } });
// hide search results on click to document
$(document).bind('click', function (e) { $('#search-resultbox').hide(); });
// except the following:
searchBox.bind('click', function(e) { e.stopPropagation(); });
$('#search-resultbox').bind('click', function(e) { e.stopPropagation(); });

});</script></body>
</html>
